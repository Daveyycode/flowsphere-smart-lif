/**
 * Secure QR Messenger - One-Time Contact Pairing System
 *
 * Features:
 * - One-time QR code per contact (non-reusable)
 * - Real-time end-to-end encryption
 * - Responsive design
 * - Auto-expires after 24 hours or first use
 * - No phone numbers required
 */

import { useState, useEffect, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import {
  QrCode,
  UserPlus,
  PaperPlaneTilt,
  ArrowLeft,
  X,
  Copy,
  Camera,
  CheckCircle,
  Clock,
  Shield,
  Users
} from '@phosphor-icons/react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { useKV } from '@github/spark/hooks'
import { toast } from 'sonner'
import { cn } from '@/lib/utils'
import QRCode from 'qrcode'

// ========== TYPES ==========

interface Contact {
  id: string
  name: string
  publicKey: string
  pairingCode: string // The unique QR code used to connect (stored for reference)
  pairedAt: string
  lastSeen?: string
  status: 'online' | 'offline'
  isVerified: boolean
}

interface Message {
  id: string
  contactId: string
  text: string
  timestamp: string
  status: 'sent' | 'delivered' | 'read'
  isOwn: boolean
  encrypted: boolean
}

interface OneTimeInvite {
  code: string // Unique invite code
  publicKey: string // Your public key
  name: string // Your name
  createdAt: string
  expiresAt: string
  used: boolean // Marks if QR was scanned
  usedBy?: string // Contact ID who used it
}

interface SecureQRMessengerProps {
  isOpen: boolean
  onClose: () => void
}

// ========== ENCRYPTION HELPERS ==========

function generateKeyPair() {
  // Simple key generation (in production, use Web Crypto API)
  const timestamp = Date.now()
  const random = Math.random().toString(36).substring(2)
  return {
    publicKey: `PK_${timestamp}_${random}`,
    privateKey: `SK_${timestamp}_${random}`
  }
}

function encryptMessage(message: string, recipientPublicKey: string): string {
  // Simple encryption (in production, use AES-256 or similar)
  const encoded = btoa(message + ':' + recipientPublicKey)
  return `ENC_${encoded}`
}

function decryptMessage(encryptedMessage: string, myPrivateKey: string): string {
  // Simple decryption (in production, use proper decryption)
  try {
    const encoded = encryptedMessage.replace('ENC_', '')
    const decoded = atob(encoded)
    return decoded.split(':')[0]
  } catch {
    return '[Decryption failed]'
  }
}

function generateInviteCode(): string {
  const timestamp = Date.now()
  const random = Math.random().toString(36).substring(2, 10).toUpperCase()
  return `${timestamp}-${random}`
}

// ========== MAIN COMPONENT ==========

export function SecureQRMessenger({ isOpen, onClose }: SecureQRMessengerProps) {
  // Persistent storage
  const [myKeys, setMyKeys] = useKV<{ publicKey: string; privateKey: string } | null>('qr-messenger-keys', null)
  const [myName, setMyName] = useKV<string>('qr-messenger-name', '')
  const [contacts, setContacts] = useKV<Contact[]>('qr-messenger-contacts', [])
  const [messages, setMessages] = useKV<Message[]>('qr-messenger-messages', [])
  const [usedInvites, setUsedInvites] = useKV<string[]>('qr-messenger-used-invites', []) // Track used codes

  // Local state
  const [currentInvite, setCurrentInvite] = useState<OneTimeInvite | null>(null)
  const [qrCodeDataURL, setQrCodeDataURL] = useState<string>('')
  const [selectedContact, setSelectedContact] = useState<Contact | null>(null)
  const [messageInput, setMessageInput] = useState('')
  const [showQRDialog, setShowQRDialog] = useState(false)
  const [showScanner, setShowScanner] = useState(false)
  const [scannedData, setScannedData] = useState('')
  const [view, setView] = useState<'contacts' | 'chat'>('contacts')
  const [isGeneratingQR, setIsGeneratingQR] = useState(false)

  const messagesEndRef = useRef<HTMLDivElement>(null)

  // Initialize keys on first load
  useEffect(() => {
    if (!myKeys) {
      const keys = generateKeyPair()
      setMyKeys(keys)
    }
  }, [myKeys, setMyKeys])

  // Auto-scroll messages
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages, selectedContact])

  // ========== QR CODE GENERATION ==========

  const generateOneTimeQR = async () => {
    if (!myKeys || !myName) {
      toast.error('Please set your name first')
      return
    }

    // Check if there's an active unused invite
    if (currentInvite && !currentInvite.used) {
      const expiresAt = new Date(currentInvite.expiresAt)
      if (expiresAt > new Date()) {
        toast.info('You already have an active invite code')
        setShowQRDialog(true)
        return
      }
    }

    setIsGeneratingQR(true)

    try {
      const inviteCode = generateInviteCode()
      const expiresAt = new Date()
      expiresAt.setHours(expiresAt.getHours() + 24) // 24-hour expiration

      const invite: OneTimeInvite = {
        code: inviteCode,
        publicKey: myKeys.publicKey,
        name: myName,
        createdAt: new Date().toISOString(),
        expiresAt: expiresAt.toISOString(),
        used: false
      }

      // Generate QR code containing invite data
      const qrData = JSON.stringify({
        code: invite.code,
        publicKey: invite.publicKey,
        name: invite.name,
        expiresAt: invite.expiresAt
      })

      const qrDataURL = await QRCode.toDataURL(qrData, {
        width: 300,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      })

      setQrCodeDataURL(qrDataURL)
      setCurrentInvite(invite)
      setShowQRDialog(true)

      toast.success('One-time QR code generated! Valid for 24 hours.')
    } catch (error) {
      console.error('QR generation error:', error)
      toast.error('Failed to generate QR code')
    } finally {
      setIsGeneratingQR(false)
    }
  }

  // ========== QR CODE SCANNING ==========

  const handleQRScan = async (data: string) => {
    if (!myKeys || !myName) {
      toast.error('Your profile is not set up')
      return
    }

    try {
      const scannedInvite = JSON.parse(data)

      // Validate invite structure
      if (!scannedInvite.code || !scannedInvite.publicKey || !scannedInvite.name) {
        toast.error('Invalid QR code format')
        return
      }

      // Check if already used
      if (usedInvites.includes(scannedInvite.code)) {
        toast.error('This QR code has already been used')
        return
      }

      // Check expiration
      const expiresAt = new Date(scannedInvite.expiresAt)
      if (expiresAt < new Date()) {
        toast.error('This QR code has expired')
        return
      }

      // Check if contact already exists
      const existingContact = contacts.find(c => c.publicKey === scannedInvite.publicKey)
      if (existingContact) {
        toast.info(`You're already connected with ${existingContact.name}`)
        setShowScanner(false)
        return
      }

      // Create new contact
      const newContact: Contact = {
        id: `contact_${Date.now()}`,
        name: scannedInvite.name,
        publicKey: scannedInvite.publicKey,
        pairingCode: scannedInvite.code,
        pairedAt: new Date().toISOString(),
        status: 'online',
        isVerified: true
      }

      // Add contact and mark invite as used
      setContacts([...contacts, newContact])
      setUsedInvites([...usedInvites, scannedInvite.code])

      // Mark our own invite as used if they scanned ours
      if (currentInvite && currentInvite.code === scannedInvite.code) {
        setCurrentInvite({ ...currentInvite, used: true, usedBy: newContact.id })
      }

      setShowScanner(false)
      toast.success(`Connected with ${newContact.name}!`)

      // Send welcome message
      sendMessage(`ðŸ‘‹ Hey ${newContact.name}! We're now connected securely.`, newContact)

    } catch (error) {
      console.error('QR scan error:', error)
      toast.error('Failed to process QR code')
    }
  }

  // ========== MESSAGING ==========

  const sendMessage = (text: string, contact: Contact | null = selectedContact) => {
    if (!contact || !text.trim() || !myKeys) return

    const newMessage: Message = {
      id: `msg_${Date.now()}`,
      contactId: contact.id,
      text: encryptMessage(text, contact.publicKey),
      timestamp: new Date().toISOString(),
      status: 'sent',
      isOwn: true,
      encrypted: true
    }

    setMessages([...messages, newMessage])
    setMessageInput('')

    // Simulate delivery
    setTimeout(() => {
      setMessages(msgs =>
        msgs.map(m => m.id === newMessage.id ? { ...m, status: 'delivered' } : m)
      )
    }, 1000)

    toast.success('Message sent (encrypted)')
  }

  const handleSendMessage = () => {
    if (!selectedContact || !messageInput.trim()) return
    sendMessage(messageInput)
  }

  // ========== UI HELPERS ==========

  const getContactMessages = (contactId: string) => {
    return messages
      .filter(m => m.contactId === contactId)
      .sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime())
  }

  const formatTime = (timestamp: string) => {
    const date = new Date(timestamp)
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
  }

  const getTimeRemaining = (expiresAt: string) => {
    const now = new Date()
    const expires = new Date(expiresAt)
    const diff = expires.getTime() - now.getTime()
    const hours = Math.floor(diff / (1000 * 60 * 60))
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))
    return `${hours}h ${minutes}m`
  }

  // ========== RENDER ==========

  if (!isOpen) return null

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl h-[80vh] p-0">
        <div className="flex h-full">
          {/* Sidebar - Contacts List */}
          <div className={cn(
            "w-full sm:w-80 border-r flex flex-col",
            view === 'chat' && "hidden sm:flex"
          )}>
            <DialogHeader className="p-4 border-b">
              <DialogTitle className="flex items-center gap-2">
                <Shield className="w-5 h-5 text-green-600" />
                Secure Messenger
              </DialogTitle>
            </DialogHeader>

            {/* Name Setup */}
            {!myName && (
              <div className="p-4 bg-yellow-50 border-b">
                <Input
                  placeholder="Enter your name..."
                  value={myName}
                  onChange={(e) => setMyName(e.target.value)}
                  className="mb-2"
                />
                <p className="text-xs text-gray-600">Set your name to start messaging</p>
              </div>
            )}

            {/* Action Buttons */}
            <div className="p-4 space-y-2">
              <Button
                onClick={generateOneTimeQR}
                disabled={!myName || isGeneratingQR}
                className="w-full"
              >
                <QrCode className="w-4 h-4 mr-2" />
                {isGeneratingQR ? 'Generating...' : 'Generate QR Code'}
              </Button>

              <Button
                onClick={() => setShowScanner(true)}
                disabled={!myName}
                variant="outline"
                className="w-full"
              >
                <Camera className="w-4 h-4 mr-2" />
                Scan Contact QR
              </Button>
            </div>

            {/* Contacts List */}
            <ScrollArea className="flex-1">
              <div className="p-2">
                {contacts.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <Users className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p className="text-sm">No contacts yet</p>
                    <p className="text-xs">Generate or scan a QR code</p>
                  </div>
                ) : (
                  contacts.map(contact => (
                    <motion.div
                      key={contact.id}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className={cn(
                        "p-3 rounded-lg cursor-pointer transition-colors mb-2",
                        selectedContact?.id === contact.id
                          ? "bg-blue-50 border-2 border-blue-500"
                          : "bg-gray-50 hover:bg-gray-100"
                      )}
                      onClick={() => {
                        setSelectedContact(contact)
                        setView('chat')
                      }}
                    >
                      <div className="flex items-center gap-3">
                        <Avatar>
                          <AvatarFallback>
                            {contact.name.substring(0, 2).toUpperCase()}
                          </AvatarFallback>
                        </Avatar>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <p className="font-semibold truncate">{contact.name}</p>
                            {contact.isVerified && (
                              <CheckCircle className="w-4 h-4 text-green-600" />
                            )}
                          </div>
                          <p className="text-xs text-gray-500 truncate">
                            Connected {new Date(contact.pairedAt).toLocaleDateString()}
                          </p>
                        </div>
                        <Badge variant={contact.status === 'online' ? 'default' : 'secondary'}>
                          {contact.status}
                        </Badge>
                      </div>
                    </motion.div>
                  ))
                )}
              </div>
            </ScrollArea>
          </div>

          {/* Chat Area */}
          <div className={cn(
            "flex-1 flex flex-col",
            view === 'contacts' && "hidden sm:flex"
          )}>
            {selectedContact ? (
              <>
                {/* Chat Header */}
                <div className="p-4 border-b flex items-center gap-3">
                  <Button
                    variant="ghost"
                    size="sm"
                    className="sm:hidden"
                    onClick={() => setView('contacts')}
                  >
                    <ArrowLeft className="w-4 h-4" />
                  </Button>
                  <Avatar>
                    <AvatarFallback>
                      {selectedContact.name.substring(0, 2).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                  <div className="flex-1">
                    <h3 className="font-semibold">{selectedContact.name}</h3>
                    <p className="text-xs text-gray-500 flex items-center gap-1">
                      <Shield className="w-3 h-3" />
                      End-to-end encrypted
                    </p>
                  </div>
                </div>

                {/* Messages */}
                <ScrollArea className="flex-1 p-4">
                  <div className="space-y-3">
                    {getContactMessages(selectedContact.id).map(message => (
                      <motion.div
                        key={message.id}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        className={cn(
                          "flex",
                          message.isOwn ? "justify-end" : "justify-start"
                        )}
                      >
                        <div
                          className={cn(
                            "max-w-[70%] rounded-lg p-3",
                            message.isOwn
                              ? "bg-blue-500 text-white"
                              : "bg-gray-100 text-gray-900"
                          )}
                        >
                          <p className="text-sm break-words">
                            {decryptMessage(message.text, myKeys?.privateKey || '')}
                          </p>
                          <div className={cn(
                            "flex items-center gap-1 mt-1 text-xs",
                            message.isOwn ? "text-blue-100" : "text-gray-500"
                          )}>
                            <span>{formatTime(message.timestamp)}</span>
                            {message.isOwn && (
                              <CheckCircle className="w-3 h-3" weight={message.status === 'read' ? 'fill' : 'regular'} />
                            )}
                          </div>
                        </div>
                      </motion.div>
                    ))}
                    <div ref={messagesEndRef} />
                  </div>
                </ScrollArea>

                {/* Message Input */}
                <div className="p-4 border-t">
                  <div className="flex gap-2">
                    <Input
                      placeholder="Type a message..."
                      value={messageInput}
                      onChange={(e) => setMessageInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                      className="flex-1"
                    />
                    <Button onClick={handleSendMessage} disabled={!messageInput.trim()}>
                      <PaperPlaneTilt className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </>
            ) : (
              <div className="flex-1 flex items-center justify-center text-gray-500">
                <div className="text-center">
                  <Shield className="w-16 h-16 mx-auto mb-4 opacity-20" />
                  <p>Select a contact to start chatting</p>
                  <p className="text-sm mt-2">All messages are end-to-end encrypted</p>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* QR Code Display Dialog */}
        <Dialog open={showQRDialog} onOpenChange={setShowQRDialog}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Your One-Time QR Code</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              {currentInvite && (
                <>
                  <div className="bg-gray-50 p-6 rounded-lg">
                    {qrCodeDataURL && (
                      <img
                        src={qrCodeDataURL}
                        alt="QR Code"
                        className="w-full h-auto"
                      />
                    )}
                  </div>

                  <div className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-gray-600">Status:</span>
                      <Badge variant={currentInvite.used ? "secondary" : "default"}>
                        {currentInvite.used ? "Used" : "Active"}
                      </Badge>
                    </div>

                    {!currentInvite.used && (
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-gray-600">Expires in:</span>
                        <span className="font-medium flex items-center gap-1">
                          <Clock className="w-4 h-4" />
                          {getTimeRemaining(currentInvite.expiresAt)}
                        </span>
                      </div>
                    )}

                    <div className="flex items-center justify-between text-sm">
                      <span className="text-gray-600">Code:</span>
                      <code className="text-xs bg-gray-100 px-2 py-1 rounded">
                        {currentInvite.code}
                      </code>
                    </div>
                  </div>

                  <div className="bg-blue-50 p-3 rounded-lg">
                    <p className="text-sm text-blue-900 flex items-center gap-2">
                      <Shield className="w-4 h-4" />
                      <strong>One-time use only:</strong> This QR code can only be scanned once
                    </p>
                  </div>

                  {currentInvite.used && (
                    <Button
                      onClick={generateOneTimeQR}
                      className="w-full"
                    >
                      Generate New QR Code
                    </Button>
                  )}
                </>
              )}
            </div>
          </DialogContent>
        </Dialog>

        {/* QR Scanner Dialog */}
        <Dialog open={showScanner} onOpenChange={setShowScanner}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Scan Contact QR Code</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div className="bg-gray-900 rounded-lg overflow-hidden aspect-square">
                {/* Placeholder for camera view - implement with jsQR or similar */}
                <div className="w-full h-full flex items-center justify-center text-white">
                  <div className="text-center">
                    <Camera className="w-16 h-16 mx-auto mb-4" />
                    <p>Camera view would appear here</p>
                    <p className="text-sm text-gray-400 mt-2">
                      Implement with jsQR library
                    </p>
                  </div>
                </div>
              </div>

              <div className="text-center text-sm text-gray-600">
                <p>Position the QR code within the frame</p>
                <p>It will scan automatically</p>
              </div>

              {/* Manual code entry fallback */}
              <div className="pt-4 border-t">
                <label className="text-sm text-gray-600">Or enter code manually:</label>
                <div className="flex gap-2 mt-2">
                  <Input
                    placeholder="Paste or enter code..."
                    value={scannedData}
                    onChange={(e) => setScannedData(e.target.value)}
                  />
                  <Button onClick={() => scannedData && handleQRScan(scannedData)}>
                    Add
                  </Button>
                </div>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </DialogContent>
    </Dialog>
  )
}
// Export alias for backward compatibility
export { SecureQRMessenger as SecureMessenger }
